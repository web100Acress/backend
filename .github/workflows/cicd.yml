name: Deploy 100Acress Backend (PM2)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1️⃣ Code checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Create .env file (PRODUCTION)
      - name: Create .env file
        run: |
          echo "NODE_ENV=production" > .env
          echo "PORT=3500" >> .env

          echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> .env
          echo "AWS_S3_ACCESS_KEY=${{ secrets.AWS_S3_ACCESS_KEY }}" >> .env
          echo "AWS_S3_SECRET_ACESS_KEY=${{ secrets.AWS_S3_SECRET_ACESS_KEY }}" >> .env
          echo "AWS_S3_BUCKET_NAME=${{ secrets.AWS_S3_BUCKET_NAME }}" >> .env

          echo "MONGO_PASSWORD=${{ secrets.MONGO_PASSWORD }}" >> .env
          echo "AWS_SDK_LOAD_CONFIG=1" >> .env

      # 3️⃣ Install dependencies (clean & production)
      - name: Install dependencies
        run: |
          npm install --production

      # 4️⃣ Restart backend safely with PM2
      - name: Restart Backend with PM2
        run: |
          pm2 describe hundredacress-backend \
            && pm2 restart hundredacress-backend \
            || pm2 start server.js --name hundredacress-backend

      # 5️⃣ Save PM2 process list
      - name: Save PM2 state
        run: pm2 save
